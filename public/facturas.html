<html ng-app="MarmolistasElPilarApp">
<head>
    <title>
        Marmolistas El Pilar
    </title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="/bower_components/jquery/dist/jquery.min.js" type="text/javascript"></script>
    <link href="/css/materialize.css" rel="stylesheet" type="text/css"/>
    <link href="/css/styles.css" rel="stylesheet"/>
    <script src="/bower_components/angular/angular.min.js" type="text/javascript"></script>
    <script src="/bower_components/angular-route/angular-route.min.js" type="text/javascript"></script>
    <script src="/materialize/js/bin/materialize.js" type="text/javascript"></script>
    <script src="/js/app.js" type="text/javascript"></script>
    <script src="/js/bills-controller.js" type="text/javascript"></script>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
</head>
<body ng-controller="BillsCtrl">
<div class="navbar-fixed">
    <nav>
        <div class="nav-wrapper">
            <a href="#" class="brand-logo"><img class="logo" src="/img/logo.png"></a>
            <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
            <ul class="right hide-on-med-and-down">
                <li><a href="/">Inicio</a></li>
                <li><a href="/articulos">Artículos</a></li>
                <li><a href="/grupos">Grupos</a></li>
                <li class="active"><a href="/clientes">Clientes</a></li>
                <li><a href="/proveedores">Proveedores</a></li>
            </ul>
        </div>
    </nav>
</div>

<ul class="sidenav" id="mobile-demo">
    <li><a href="/">Inicio</a></li>
    <li><a href="/articulos">Artículos</a></li>
    <li><a href="/grupos">Grupos</a></li>
    <li class="active"><a href="/clientes">Clientes</a></li>
    <li><a href="/proveedores">Proveedores</a></li>
</ul>
<div class="row">
    <div class="col s7">
        <div class="card">
            <div class="card-content">
                <span class="card-title"><h5>Lista de Artículos</h5></span>
                <table class="responsive-table">
                    <thead>
                    <tr>
                        <th>DESCRIPCIÓN</th>
                        <th>UNIDADES</th>
                        <th>MEDIDAS</th>
                        <th>CANTIDAD</th>
                        <th>PRECIO</th>
                        <th>DESCUENTO</th>
                        <th>TOTAL</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr ng-repeat="item in items track by $index">
                        <td><p ng-if="item.articulo.nombre">{{item.articulo.nombre}}</p></td>
                        <td><p ng-if="item.unidades">{{item.unidades}}</p></td>
                        <td><p ng-if="item.dimension.alto && item.dimension.ancho">{{item.dimension.alto}} *
                            {{item.dimension.ancho}}</p></td>
                        <td><p ng-if="item.cantidad">{{item.cantidad * item.unidades}} M2</p></td>
                        <td><p ng-if="item.tarifa">{{item.tarifa}} €</p></td>
                        <td><p ng-if="item.descuento">{{item.descuento}} %</p></td>
                        <td><p ng-if="item.total">{{item.total}} €</p></td>
                        <td><a href="#!">
                            <i class="material-icons red-text"
                               ng-click="removeItem($index)" onclick="event.stopPropagation();">delete</i>
                        </a></td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="card-content">
                <hr>
                <div class="row">
                    <div class="col s3">
                        <h6><b>Bruto: </b>{{getTotal(1)}}€</h6>
                    </div>
                    <div class="col s3">
                        <h6><b>IVA: </b>{{bill.iva ? getTotal(0.21) : 0}}€</h6>
                    </div>
                    <div class="col s3">
                        <h6><b>A Pagar: </b>{{bill.iva && bill.rec ? getTotal(1.27292) : bill.iva ? getTotal(1.21) :
                            bill.rec ? getTotal(1.052) : getTotal(1)}}€</h6>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s8">
                        <input type="text" id="custom_item"
                               ng-model="newCustomItem.articulo.nombre"
                               placeholder="Añadir entrada personalizada">
                        <label id="custom_label" for="custom_item">Entrada Personalizada</label>
                    </div>
                    <div class="input-field col s1">
                        <a class="btn-floating btn-medium waves-effect waves-light orange"
                           ng-click="addCustomItem()" onclick="event.stopPropagation();"><i
                                class="material-icons">add</i></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-content">
                <span class="card-title"><h5>Observaciones</h5></span>
                <label for="observaciones_publicas">Observaciones</label>
                <textarea id="observaciones_publicas" class="materialize-textarea"
                          ng-model="bill.observaciones_publicas"
                          placeholder="Observaciones que aparecerán en el documento"></textarea>
            </div>
        </div>
    </div>
    <div class="col s5">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <div class="row">
                        <div class="col s12">
                            <h5>Cliente: {{cliente.nombre}}</h5>
                            <h6>Tarifa predeterminada: {{tarifas[cliente.tarifa].nombre}}</h6>
                            <h6>
                                <label>
                                    <input type="checkbox" ng-model="bill.rec" ng-init="cliente.rec"/>
                                    <span>Rec. Equiv.</span>
                                </label>
                            </h6>
                            <h6>
                                <label>
                                    <input type="checkbox" ng-model="bill.iva" ng-init="bill.iva = true"/>
                                    <span>IVA</span>
                                </label>
                            </h6>
                            <div class="input-field">
                                <select ng-model="bill.formadepago" id="formadepago">
                                    <option ng-repeat="formadepago in formadepagos" ng-value="formadepago._id"
                                            ng-selected="formadepago._id == cliente.formadepago">{{formadepago.nombre}}
                                    </option>
                                </select>
                                <label for="formadepago">Forma de pago</label>
                            </div>
                            <label for="observaciones_internas">Observaciones</label>
                            <textarea id="observaciones_internas" class="materialize-textarea"
                                      ng-model="bill.observaciones_internas"
                                      placeholder="Observaciones que aparecerán solo aquí"></textarea>
                        </div>
                        <div class="row center">
                            <h5>
                                <a class="waves-effect waves-light btn blue" ng-click="saveDocument(0)">A</a>
                                <a class="waves-effect waves-light btn blue" ng-click="saveDocument(1)">P</a>
                                <a class="waves-effect waves-light btn blue" ng-click="saveDocument(2)">F</a>
                                <a class="waves-effect waves-light btn blue" ng-click="saveDocument(3)">F.P.</a>
                            </h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title"><h5>Agregar Artículos</h5></span>
                    <div class="row">
                        <div class="col s6">
                            <div class="input-field">
                                <i class="material-icons prefix">filter_1</i>
                                <input id="search_code" type="text" class="validate" ng-model="filter_codigo">
                                <label id="label_code" for="search_code">Código</label>
                            </div>
                        </div>
                        <div class="col s6">
                            <div class="input-field">
                                <i class="material-icons prefix">font_download</i>
                                <input id="search_name" type="text" class="validate" ng-model="filter_nombre">
                                <label id="label_name" for="search_name">Nombre</label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <ul class="collapsible">
                            <li ng-repeat="articulo in articles | filter:filterArticle track by $index">
                                <div class="collapsible-header item row item">
                                    <div class="col s6 left-align">
                                        <b>{{articulo.codigo}} - {{articulo.nombre}}</b>
                                    </div>
                                    <div class="col s6 right-align">
                                        <a href="#!">
                                            <i class="material-icons green-text" ng-click="setSelectedItem($index)"
                                               onclick="event.stopPropagation();">add_box</i>
                                        </a>
                                    </div>
                                </div>
                                <div class="collapsible-body">
                                    <div class="row">
                                        <div class="row">
                                            <div class="col s4">
                                                <b>Código:</b> {{articulo.codigo}}
                                            </div>
                                            <div class="col s8">
                                                <b>Nombre:</b> {{articulo.nombre}}
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col s4">
                                                <b>Dimensión:</b> {{articulo.dimension.alto}} *
                                                {{articulo.dimension.ancho}}
                                            </div>
                                            <div class="col s4">
                                                <b>Unidad:</b> {{articulo.unidad}}
                                            </div>
                                            <div class="col s4">
                                                <b>Grupo:</b> {{(groups | filter: {'_id': articulo.grupo})[0].nombre }}
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col s4">
                                                <b>T. General:</b> {{articulo.tarifas[0].valor}}
                                            </div>
                                            <div class="col s4">
                                                <b>T. Encimera:</b> {{articulo.tarifas[1].valor}}
                                            </div>
                                            <div class="col s4">
                                                <b>T. Contratista:</b> {{articulo.tarifas[2].valor}}
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col s4">
                                                <b>T. Público:</b> {{articulo.tarifas[3].valor}}
                                            </div>
                                            <div class="col s4">
                                                <b>IVA:</b> {{articulo.iva}}
                                            </div>
                                            <div class="col s4">
                                                <b>Precio Costo:</b> {{articulo.precio_costo}}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal Structure -->
<div id="addArticle" class="modal">
    <div class="modal-content">
        <h4>Añadir "{{selectedItem.codigo}} - {{selectedItem.nombre}}"</h4>
        <form name="addItemForm" id="addItemForm" class="col s12" ng-submit="addItem()">
            <div class="row">
                <div class="input-field col s12">
                    <input id="unidades" ng-model="newItem.unidades" type="number" class="validate" placeholder="1">
                    <label for="unidades">Cantidad</label>
                </div>
                <div class="input-field col s12" ng-if="selectedItem.unidad.toUpperCase()==='M2'">
                    <div class="row">
                        <div class="col s6">
                            <input id="alto" ng-model="newItem.dimension.alto" type="number"
                                   class="validate" placeholder="100">
                            <label for="alto">Alto</label>
                        </div>
                        <div class="col s6">
                            <input id="ancho" ng-model="newItem.dimension.ancho" type="number"
                                   class="validate" placeholder="100">
                            <label for="ancho">Ancho</label>
                        </div>
                    </div>
                </div>
                <div class="input-field col s12">
                    <select ng-model="newItem.tarifa" id="tarifa">
                        <option ng-repeat="tarifa in selectedItem.tarifas track by $index" value="{{tarifa.valor}}">
                            {{tarifa.nombre}}
                        </option>
                    </select>
                    <label>Tarifa</label>
                </div>
                <div class="input-field col s12">
                    <input id="descuento" ng-model="newItem.descuento" type="number" class="validate" placeholder="0"
                           min="0" max="100">
                    <label for="descuento">Descuento (%)</label>
                </div>
            </div>
            <div class="center">
                <button class="btn-small waves-effect waves-light green" type="submit" name="action">
                    AGREGAR
                    <i class="material-icons right">add</i>
                </button>
            </div>
        </form>
        <table class="responsive-table">
            <thead>
            <tr>
                <th>UNIDADES</th>
                <th>MEDIDAS</th>
                <th>CANTIDAD</th>
                <th>PRECIO</th>
                <th>DESCUENTO</th>
                <th>TOTAL</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td><p ng-if="newItem.unidades">{{newItem.unidades}}</p></td>
                <td><p ng-if="newItem.dimension.alto && newItem.dimension.ancho">{{newItem.dimension.alto}} *
                    {{newItem.dimension.ancho}}</p></td>
                <td><p ng-if="newItem.dimension.alto && newItem.dimension.ancho && newItem.unidades">
                    {{((newItem.dimension.alto *
                    newItem.dimension.ancho)/10000) * newItem.unidades}} M2</p></td>
                <td><p ng-if="newItem.tarifa">{{newItem.tarifa}} €</p></td>
                <td><p ng-if="typeof(newItem.descuento)!='undefined'">{{newItem.descuento}} %</p></td>
                <td ng-if="selectedItem.unidad.toUpperCase()==='M2'">
                    <p ng-if="newItem.unidades && newItem.dimension.alto && newItem.dimension.ancho && newItem.tarifa && typeof(newItem.descuento)!='undefined'">
                        {{(( ( newItem.dimension.alto * newItem.dimension.ancho ) / 10000 ) * newItem.tarifa )
                        * ( (100 - newItem.descuento) / 100) * newItem.unidades | number : 2}} €</p>
                </td>
                <td ng-if="selectedItem.unidad.toUpperCase()===('ML' || 'UNIDAD')">
                    <p ng-if="newItem.unidades && newItem.tarifa && typeof(newItem.descuento)!='undefined'">
                        {{ newItem.tarifa * newItem.unidades * ((100 - newItem.descuento) / 100) | number :2 }}€
                    </p>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>
</body>
<script>
    $(document).ready(function () {
        $('.sidenav').sidenav();
        $('.collapsible').collapsible();
        $('.modal').modal();
        $('select').formSelect();
    });
</script>
</html>
